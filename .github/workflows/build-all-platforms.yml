name: Build All Platforms

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Select environment"
        required: true
        type: choice
        options:
          - Staging
          - Production
        default: "Staging"
      version:
        description: "Version to build"
        required: true
        type: string
      os:
        description: "Which OS to build"
        required: true
        default: "All"
        type: choice
        options:
          - All
          - MacOS
          - Windows
          - Linux

run-name: "OS: ${{ github.event.inputs.os }} / ENV: ${{ github.event.inputs.env }} - v${{ github.event.inputs.version }}"

jobs:
  build-mac:
    if: ${{ github.event.inputs.os == 'All' || github.event.inputs.os == 'MacOS' }}
    name: MacOS
    uses: ./.github/workflows/build-mac.yml
    with:
      env: ${{ github.event.inputs.env }}
      version: ${{ github.event.inputs.version }}
    secrets: inherit

  build-windows:
    if: ${{ github.event.inputs.os == 'All' || github.event.inputs.os == 'Windows' }}
    name: Windows
    uses: ./.github/workflows/build-windows.yml
    with:
      env: ${{ github.event.inputs.env }}
      version: ${{ github.event.inputs.version }}
    secrets: inherit

  build-linux:
    if: ${{ github.event.inputs.os == 'All' || github.event.inputs.os == 'Linux' }}
    name: Linux
    uses: ./.github/workflows/build-linux.yml
    with:
      env: ${{ github.event.inputs.env }}
      version: ${{ github.event.inputs.version }}
    secrets: inherit

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [build-mac, build-windows, build-linux]
    if: >
      (
        (
          github.event.inputs.os != 'MacOS' &&
          github.event.inputs.os != 'All'
        ) || (
          needs.build-mac.result == 'success'
        )
      ) &&
      (
        (
          github.event.inputs.os != 'Windows' &&
          github.event.inputs.os != 'All'
        ) || (
          needs.build-windows.result == 'success'
        )
      ) &&
      (
        (
          github.event.inputs.os != 'Linux' &&
          github.event.inputs.os != 'All'
        ) || (
          needs.build-linux.result == 'success'
        )
      )
    steps:
      - name: Check out
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref_name }}

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Publish S3 Links
        run: |
          if [ "${{ github.event.inputs.env }}" = "Staging" ]; then
            npm run publish-links-staging
          else
            npm run publish-links-production
          fi

      - name: Notify success
        uses: sarisia/actions-status-discord@v1
        if: success()
        continue-on-error: true
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          title: "6529 Core: Internal links published ‚úÖ"
          description: "OS: ${{ github.event.inputs.os }} / ENV: ${{ github.event.inputs.env }} - v${{ github.event.inputs.version }}"
          color: 0x00bfff

      - name: Publish Arweave Links
        run: |
          if [ "${{ github.event.inputs.env }}" = "Staging" ]; then
            npm run publish-links-staging-arweave
          else
            npm run publish-links-production-arweave
          fi

      - name: Final success - After Arweave
        uses: sarisia/actions-status-discord@v1
        if: success()
        continue-on-error: true
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          title: "6529 Core: Build complete üöÄ"
          description: "OS: ${{ github.event.inputs.os }} / ENV: ${{ github.event.inputs.env }} - v${{ github.event.inputs.version }}"
          color: 0x00ff00

      - name: Notify about failure
        uses: sarisia/actions-status-discord@v1
        if: failure()
        continue-on-error: true
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          title: "6529 Core: Build failed ‚ùå"
          description: "OS: ${{ github.event.inputs.os }} / ENV: ${{ github.event.inputs.env }} - v${{ github.event.inputs.version }}"
          content: "<@&1162355330798325861>"
          color: 0xff0000

      - name: Summary
        uses: actions/github-script@v7
        with:
          script: |
            core.summary
              .addHeading("6529 Core Build Complete üöÄ")
              .addTable([
                ["OS", "${{ github.event.inputs.os }}"],
                ["Env", "${{ github.event.inputs.env }}"],
                ["Version", "${{ github.event.inputs.version }}"]
              ])
              .write()
